// API endpoint: –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∏ —Ç–æ–ø —Å—Ç—Ä–∞–Ω
import { Redis } from '@upstash/redis';

const kv = new Redis({
  url: process.env.KV_REST_API_URL,
  token: process.env.KV_REST_API_TOKEN,
});

// –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–¥–æ–≤ —Å—Ç—Ä–∞–Ω –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è —Å —Ñ–ª–∞–≥–∞–º–∏ (–∏–∑ reveal-batch.js)
const countryNames = {
    'RU': 'üá∑üá∫ –†–æ—Å—Å–∏—è',
    'US': 'üá∫üá∏ –°–®–ê',
    'CA': 'üá®üá¶ –ö–∞–Ω–∞–¥–∞',
    'BR': 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è',
    'CN': 'üá®üá≥ –ö–∏—Ç–∞–π',
    'AU': 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è',
    'IN': 'üáÆüá≥ –ò–Ω–¥–∏—è',
    'FR': 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è',
    'DE': 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è',
    'IT': 'üáÆüáπ –ò—Ç–∞–ª–∏—è',
    'ES': 'üá™üá∏ –ò—Å–ø–∞–Ω–∏—è',
    'GB': 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è',
    'JP': 'üáØüáµ –Ø–ø–æ–Ω–∏—è',
    'MX': 'üá≤üáΩ –ú–µ–∫—Å–∏–∫–∞',
    'AR': 'üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞',
    'NO': 'üá≥üá¥ –ù–æ—Ä–≤–µ–≥–∏—è',
    'SE': 'üá∏üá™ –®–≤–µ—Ü–∏—è',
    'FI': 'üá´üáÆ –§–∏–Ω–ª—è–Ω–¥–∏—è',
    'DK': 'üá©üá∞ –î–∞–Ω–∏—è',
    'IS': 'üáÆüá∏ –ò—Å–ª–∞–Ω–¥–∏—è',
    'IE': 'üáÆüá™ –ò—Ä–ª–∞–Ω–¥–∏—è',
    'PL': 'üáµüá± –ü–æ–ª—å—à–∞',
    'PT': 'üáµüáπ –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è',
    'NL': 'üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã',
    'BE': 'üáßüá™ –ë–µ–ª—å–≥–∏—è',
    'CH': 'üá®üá≠ –®–≤–µ–π—Ü–∞—Ä–∏—è',
    'AT': 'üá¶üáπ –ê–≤—Å—Ç—Ä–∏—è',
    'CZ': 'üá®üáø –ß–µ—Ö–∏—è',
    'UA': 'üá∫üá¶ –£–∫—Ä–∞–∏–Ω–∞',
    'BY': 'üáßüáæ –ë–µ–ª–∞—Ä—É—Å—å',
    'LT': 'üá±üáπ –õ–∏—Ç–≤–∞',
    'LV': 'üá±üáª –õ–∞—Ç–≤–∏—è',
    'EE': 'üá™üá™ –≠—Å—Ç–æ–Ω–∏—è',
    'GR': 'üá¨üá∑ –ì—Ä–µ—Ü–∏—è',
    'TR': 'üáπüá∑ –¢—É—Ä—Ü–∏—è',
    'CL': 'üá®üá± –ß–∏–ª–∏',
    'KR': 'üá∞üá∑ –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è',
    'ID': 'üáÆüá© –ò–Ω–¥–æ–Ω–µ–∑–∏—è',
    'TH': 'üáπüá≠ –¢–∞–∏–ª–∞–Ω–¥',
    'VN': 'üáªüá≥ –í—å–µ—Ç–Ω–∞–º',
    'KZ': 'üá∞üáø –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω',
    'MN': 'üá≤üá≥ –ú–æ–Ω–≥–æ–ª–∏—è',
    'IR': 'üáÆüá∑ –ò—Ä–∞–Ω',
    'SA': 'üá∏üá¶ –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è',
    'EG': 'üá™üá¨ –ï–≥–∏–ø–µ—Ç',
    'ZA': 'üáøüá¶ –Æ–ê–†',
    'NG': 'üá≥üá¨ –ù–∏–≥–µ—Ä–∏—è',
    'KE': 'üá∞üá™ –ö–µ–Ω–∏—è',
    'DZ': 'üá©üáø –ê–ª–∂–∏—Ä',
    'NZ': 'üá≥üáø –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è',
    'XX': '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
};

// –ü–ª–æ—â–∞–¥—å —Å—Ç—Ä–∞–Ω –≤ –∫–º¬≤ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
const COUNTRY_AREAS = {
  'RU': 17098242,  // –†–æ—Å—Å–∏—è
  'CA': 9984670,   // –ö–∞–Ω–∞–¥–∞  
  'US': 9833517,   // –°–®–ê
  'CN': 9596961,   // –ö–∏—Ç–∞–π
  'BR': 8514877,   // –ë—Ä–∞–∑–∏–ª–∏—è
  'AU': 7692024,   // –ê–≤—Å—Ç—Ä–∞–ª–∏—è
  'IN': 3287263,   // –ò–Ω–¥–∏—è
  'AR': 2780400,   // –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞
  'KZ': 2724900,   // –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω
  'DZ': 2381741,   // –ê–ª–∂–∏—Ä
  'SA': 2149690,   // –°–∞—É–¥–æ–≤—Å–∫–∞—è –ê—Ä–∞–≤–∏—è
  'MX': 1964375,   // –ú–µ–∫—Å–∏–∫–∞
  'ID': 1904569,   // –ò–Ω–¥–æ–Ω–µ–∑–∏—è
  'LY': 1759540,   // –õ–∏–≤–∏—è
  'IR': 1648195,   // –ò—Ä–∞–Ω
  'MN': 1564110,   // –ú–æ–Ω–≥–æ–ª–∏—è
  'PE': 1285216,   // –ü–µ—Ä—É
  'TD': 1284000,   // –ß–∞–¥
  'NE': 1267000,   // –ù–∏–≥–µ—Ä
  'AO': 1246700,   // –ê–Ω–≥–æ–ª–∞
  'ML': 1240192,   // –ú–∞–ª–∏
  'ZA': 1221037,   // –Æ–ê–†
  'CO': 1141748,   // –ö–æ–ª—É–º–±–∏—è
  'ET': 1104300,   // –≠—Ñ–∏–æ–ø–∏—è
  'BO': 1098581,   // –ë–æ–ª–∏–≤–∏—è
  'MR': 1025520,   // –ú–∞–≤—Ä–∏—Ç–∞–Ω–∏—è
  'EG': 1001450,   // –ï–≥–∏–ø–µ—Ç
  'TZ': 945087,    // –¢–∞–Ω–∑–∞–Ω–∏—è
  'NG': 923768,    // –ù–∏–≥–µ—Ä–∏—è
  'VE': 916445,    // –í–µ–Ω–µ—Å—É—ç–ª–∞
  'PK': 881913,    // –ü–∞–∫–∏—Å—Ç–∞–Ω
  'MZ': 801590,    // –ú–æ–∑–∞–º–±–∏–∫
  'TR': 783562,    // –¢—É—Ä—Ü–∏—è
  'CL': 756102,    // –ß–∏–ª–∏
  'ZM': 752612,    // –ó–∞–º–±–∏—è
  'MM': 676578,    // –ú—å—è–Ω–º–∞
  'AF': 652230,    // –ê—Ñ–≥–∞–Ω–∏—Å—Ç–∞–Ω
  'SO': 637657,    // –°–æ–º–∞–ª–∏
  'CF': 622984,    // –¶–ê–†
  'UA': 603550,    // –£–∫—Ä–∞–∏–Ω–∞
  'MG': 587041,    // –ú–∞–¥–∞–≥–∞—Å–∫–∞—Ä
  'BW': 581730,    // –ë–æ—Ç—Å–≤–∞–Ω–∞
  'KE': 580367,    // –ö–µ–Ω–∏—è
  'FR': 551695,    // –§—Ä–∞–Ω—Ü–∏—è
  'YE': 527968,    // –ô–µ–º–µ–Ω
  'TH': 513120,    // –¢–∞–∏–ª–∞–Ω–¥
  'ES': 505992,    // –ò—Å–ø–∞–Ω–∏—è
  'TM': 488100,    // –¢—É—Ä–∫–º–µ–Ω–∏—Å—Ç–∞–Ω
  'CM': 475442,    // –ö–∞–º–µ—Ä—É–Ω
  'PG': 462840,    // –ü–∞–ø—É–∞-–ù–æ–≤–∞—è –ì–≤–∏–Ω–µ—è
  'SE': 450295,    // –®–≤–µ—Ü–∏—è
  'UZ': 447400,    // –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω
  'MA': 446550,    // –ú–∞—Ä–æ–∫–∫–æ
  'IQ': 438317,    // –ò—Ä–∞–∫
  'PY': 406752,    // –ü–∞—Ä–∞–≥–≤–∞–π
  'ZW': 390757,    // –ó–∏–º–±–∞–±–≤–µ
  'NO': 385207,    // –ù–æ—Ä–≤–µ–≥–∏—è
  'JP': 377975,    // –Ø–ø–æ–Ω–∏—è
  'DE': 357114,    // –ì–µ—Ä–º–∞–Ω–∏—è
  'FI': 338424,    // –§–∏–Ω–ª—è–Ω–¥–∏—è
  'VN': 331212,    // –í—å–µ—Ç–Ω–∞–º
  'MY': 330803,    // –ú–∞–ª–∞–π–∑–∏—è
  'CI': 322463,    // –ö–æ—Ç-–¥'–ò–≤—É–∞—Ä
  'PL': 312696,    // –ü–æ–ª—å—à–∞
  'OM': 309500,    // –û–º–∞–Ω
  'IT': 301339,    // –ò—Ç–∞–ª–∏—è
  'PH': 300000,    // –§–∏–ª–∏–ø–ø–∏–Ω—ã
  'EC': 283561,    // –≠–∫–≤–∞–¥–æ—Ä
  'BF': 274222,    // –ë—É—Ä–∫–∏–Ω–∞-–§–∞—Å–æ
  'NZ': 270467,    // –ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è
  'GA': 267668,    // –ì–∞–±–æ–Ω
  'GB': 242900,    // –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è
  'GN': 245857,    // –ì–≤–∏–Ω–µ—è
  'UG': 241550,    // –£–≥–∞–Ω–¥–∞
  'GH': 238533,    // –ì–∞–Ω–∞
  'RO': 238391,    // –†—É–º—ã–Ω–∏—è
  'LA': 236800,    // –õ–∞–æ—Å
  'GY': 214969,    // –ì–∞–π–∞–Ω–∞
  'BY': 207600,    // –ë–µ–ª–∞—Ä—É—Å—å
  'KG': 199951,    // –ö–∏—Ä–≥–∏–∑–∏—è
  'SN': 196722,    // –°–µ–Ω–µ–≥–∞–ª
  'SY': 185180,    // –°–∏—Ä–∏—è
  'KH': 181035,    // –ö–∞–º–±–æ–¥–∂–∞
  'UY': 176215,    // –£—Ä—É–≥–≤–∞–π
  'TN': 163610,    // –¢—É–Ω–∏—Å
  'SR': 163820,    // –°—É—Ä–∏–Ω–∞–º
  'BD': 147570,    // –ë–∞–Ω–≥–ª–∞–¥–µ—à
  'NP': 147181,    // –ù–µ–ø–∞–ª
  'TJ': 143100,    // –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω
  'GR': 131957,    // –ì—Ä–µ—Ü–∏—è
  'NI': 130373,    // –ù–∏–∫–∞—Ä–∞–≥—É–∞
  'KP': 120538,    // –°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è
  'MW': 118484,    // –ú–∞–ª–∞–≤–∏
  'ER': 117600,    // –≠—Ä–∏—Ç—Ä–µ—è
  'BJ': 114763,    // –ë–µ–Ω–∏–Ω
  'HN': 112492,    // –ì–æ–Ω–¥—É—Ä–∞—Å
  'LR': 111369,    // –õ–∏–±–µ—Ä–∏—è
  'BG': 110879,    // –ë–æ–ª–≥–∞—Ä–∏—è
  'CU': 109884,    // –ö—É–±–∞
  'GT': 108889,    // –ì–≤–∞—Ç–µ–º–∞–ª–∞
  'IS': 103000,    // –ò—Å–ª–∞–Ω–¥–∏—è
  'KR': 100210,    // –Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è
  'HU': 93028,     // –í–µ–Ω–≥—Ä–∏—è
  'PT': 92090,     // –ü–æ—Ä—Ç—É–≥–∞–ª–∏—è
  'JO': 89342,     // –ò–æ—Ä–¥–∞–Ω–∏—è
  'RS': 88361,     // –°–µ—Ä–±–∏—è
  'AZ': 86600,     // –ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω
  'AT': 83879,     // –ê–≤—Å—Ç—Ä–∏—è
  'AE': 83600,     // –û–ê–≠
  'CZ': 78867,     // –ß–µ—Ö–∏—è
  'PA': 75417,     // –ü–∞–Ω–∞–º–∞
  'SL': 71740,     // –°—å–µ—Ä—Ä–∞-–õ–µ–æ–Ω–µ
  'IE': 70273,     // –ò—Ä–ª–∞–Ω–¥–∏—è
  'GE': 69700,     // –ì—Ä—É–∑–∏—è
  'LK': 65610,     // –®—Ä–∏-–õ–∞–Ω–∫–∞
  'LT': 65300,     // –õ–∏—Ç–≤–∞
  'LV': 64559,     // –õ–∞—Ç–≤–∏—è
  'TG': 56785,     // –¢–æ–≥–æ
  'HR': 56594,     // –•–æ—Ä–≤–∞—Ç–∏—è
  'BA': 51209,     // –ë–æ—Å–Ω–∏—è –∏ –ì–µ—Ä—Ü–µ–≥–æ–≤–∏–Ω–∞
  'CR': 51100,     // –ö–æ—Å—Ç–∞-–†–∏–∫–∞
  'SK': 49037,     // –°–ª–æ–≤–∞–∫–∏—è
  'DO': 48671,     // –î–æ–º–∏–Ω–∏–∫–∞–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞
  'EE': 45227,     // –≠—Å—Ç–æ–Ω–∏—è
  'DK': 43094,     // –î–∞–Ω–∏—è
  'NL': 41850,     // –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã
  'CH': 41285,     // –®–≤–µ–π—Ü–∞—Ä–∏—è
  'BT': 38394,     // –ë—É—Ç–∞–Ω
  'TW': 36193,     // –¢–∞–π–≤–∞–Ω—å
  'GW': 36125,     // –ì–≤–∏–Ω–µ—è-–ë–∏—Å–∞—É
  'MD': 33846,     // –ú–æ–ª–¥–æ–≤–∞
  'BE': 30528,     // –ë–µ–ª—å–≥–∏—è
  'LS': 30355,     // –õ–µ—Å–æ—Ç–æ
  'AM': 29743,     // –ê—Ä–º–µ–Ω–∏—è
  'SB': 28896,     // –°–æ–ª–æ–º–æ–Ω–æ–≤—ã –û—Å—Ç—Ä–æ–≤–∞
  'AL': 28748,     // –ê–ª–±–∞–Ω–∏—è
  'GQ': 28051,     // –≠–∫–≤–∞—Ç–æ—Ä–∏–∞–ª—å–Ω–∞—è –ì–≤–∏–Ω–µ—è
  'BI': 27834,     // –ë—É—Ä—É–Ω–¥–∏
  'HT': 27750,     // –ì–∞–∏—Ç–∏
  'RW': 26338,     // –†—É–∞–Ω–¥–∞
  'MK': 25713,     // –°–µ–≤–µ—Ä–Ω–∞—è –ú–∞–∫–µ–¥–æ–Ω–∏—è
  'BZ': 22966,     // –ë–µ–ª–∏–∑
  'DJ': 23200,     // –î–∂–∏–±—É—Ç–∏
  'SV': 21041,     // –°–∞–ª—å–≤–∞–¥–æ—Ä
  'IL': 20770,     // –ò–∑—Ä–∞–∏–ª—å
  'SI': 20273,     // –°–ª–æ–≤–µ–Ω–∏—è
  'FJ': 18272,     // –§–∏–¥–∂–∏
  'KW': 17818,     // –ö—É–≤–µ–π—Ç
  'SZ': 17364,     // –≠—Å–≤–∞—Ç–∏–Ω–∏
  'TL': 14919,     // –í–æ—Å—Ç–æ—á–Ω—ã–π –¢–∏–º–æ—Ä
  'BS': 13943,     // –ë–∞–≥–∞–º—ã
  'ME': 13812,     // –ß–µ—Ä–Ω–æ–≥–æ—Ä–∏—è
  'VU': 12189,     // –í–∞–Ω—É–∞—Ç—É
  'QA': 11586,     // –ö–∞—Ç–∞—Ä
  'GM': 11295,     // –ì–∞–º–±–∏—è
  'JM': 10991,     // –Ø–º–∞–π–∫–∞
  'LB': 10452,     // –õ–∏–≤–∞–Ω
  'CY': 9251,      // –ö–∏–ø—Ä
  'BN': 5765,      // –ë—Ä—É–Ω–µ–π
  'TT': 5130,      // –¢—Ä–∏–Ω–∏–¥–∞–¥ –∏ –¢–æ–±–∞–≥–æ
  'CV': 4033,      // –ö–∞–±–æ-–í–µ—Ä–¥–µ
  'WS': 2842,      // –°–∞–º–æ–∞
  'LU': 2586,      // –õ—é–∫—Å–µ–º–±—É—Ä–≥
  'MU': 2040,      // –ú–∞–≤—Ä–∏–∫–∏–π
  'KM': 1862,      // –ö–æ–º–æ—Ä—ã
  'ST': 964,       // –°–∞–Ω-–¢–æ–º–µ –∏ –ü—Ä–∏–Ω—Å–∏–ø–∏
  'BH': 765,       // –ë–∞—Ö—Ä–µ–π–Ω
  'DM': 751,       // –î–æ–º–∏–Ω–∏–∫–∞
  'TO': 747,       // –¢–æ–Ω–≥–∞
  'KI': 726,       // –ö–∏—Ä–∏–±–∞—Ç–∏
  'SG': 718,       // –°–∏–Ω–≥–∞–ø—É—Ä
  'FM': 702,       // –ú–∏–∫—Ä–æ–Ω–µ–∑–∏—è
  'LC': 616,       // –°–µ–Ω—Ç-–õ—é—Å–∏—è
  'AD': 468,       // –ê–Ω–¥–æ—Ä—Ä–∞
  'PW': 459,       // –ü–∞–ª–∞—É
  'SC': 452,       // –°–µ–π—à–µ–ª—ã
  'AG': 442,       // –ê–Ω—Ç–∏–≥—É–∞ –∏ –ë–∞—Ä–±—É–¥–∞
  'BB': 430,       // –ë–∞—Ä–±–∞–¥–æ—Å
  'VC': 389,       // –°–µ–Ω—Ç-–í–∏–Ω—Å–µ–Ω—Ç –∏ –ì—Ä–µ–Ω–∞–¥–∏–Ω—ã
  'GD': 344,       // –ì—Ä–µ–Ω–∞–¥–∞
  'MT': 316,       // –ú–∞–ª—å—Ç–∞
  'MV': 300,       // –ú–∞–ª—å–¥–∏–≤—ã
  'KN': 261,       // –°–µ–Ω—Ç-–ö–∏—Ç—Å –∏ –ù–µ–≤–∏—Å
  'MH': 181,       // –ú–∞—Ä—à–∞–ª–ª–æ–≤—ã –û—Å—Ç—Ä–æ–≤–∞
  'LI': 160,       // –õ–∏—Ö—Ç–µ–Ω—à—Ç–µ–π–Ω
  'SM': 61,        // –°–∞–Ω-–ú–∞—Ä–∏–Ω–æ
  'TV': 26,        // –¢—É–≤–∞–ª—É
  'NR': 21,        // –ù–∞—É—Ä—É
  'MC': 2,         // –ú–æ–Ω–∞–∫–æ
  'VA': 0.44,      // –í–∞—Ç–∏–∫–∞–Ω
  'XX': 1          // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞
};

// –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–∏ –≤ –∫–º¬≤ (10x10 –∫–º)
const CELL_SIZE_KM2 = 100;

export default async function handler(req, res) {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET');
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã–µ –∫–ª–µ—Ç–∫–∏
    const allCells = await kv.smembers('revealed:cells') || [];
    
    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ (—Ç–µ –∫—Ç–æ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç)
    const now = Date.now();
    const fiveMinutesAgo = now - (5 * 60 * 1000);
    const recentActivity = await kv.zrange('revealed:timeline', fiveMinutesAgo, now, {
      byScore: true
    }) || [];
    
    const uniquePlayers = new Set();
    recentActivity.forEach(item => {
      if (item && item.member) {
        const parts = item.member.split(':');
        if (parts[1]) uniquePlayers.add(parts[1]);
      }
    });
    
    const onlinePlayers = Math.max(1, uniquePlayers.size);
    
    // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
    const countryStats = [];
    const countryData = await kv.hgetall('country:revealed:count') || {};
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-10 —Å—Ç—Ä–∞–Ω —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–∞—Å–∫—Ä—ã—Ç—ã—Ö –∫–ª–µ—Ç–æ–∫
    const sortedCountries = Object.entries(countryData)
      .map(([code, count]) => ({
        code,
        count: parseInt(count) || 0
      }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);
    
    // –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω—ã –∏–∑ —Ç–æ–ø-10 —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç
    for (const { code, count } of sortedCountries) {
      const countryArea = COUNTRY_AREAS[code] || 100000; // –ü–ª–æ—â–∞–¥—å —Å—Ç—Ä–∞–Ω—ã –≤ –∫–º¬≤
      const maxCells = Math.floor(countryArea / CELL_SIZE_KM2); // –ú–∞–∫—Å–∏–º—É–º –∫–ª–µ—Ç–æ–∫ –≤ —Å—Ç—Ä–∞–Ω–µ
      const percentage = ((count / maxCells) * 100).toFixed(4);
      
      // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –æ–±—ä–µ–∫—Ç–∞
      const name = countryNames[code] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      
      countryStats.push({
        name,
        cells: count,
        percentage: parseFloat(percentage),
        maxCells
      });
    }
    
    // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 10 —Å—Ç—Ä–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω—ã —Å 0 –∫–ª–µ—Ç–∫–∞–º–∏
    if (countryStats.length < 10) {
      const missingCountries = [
        { name: 'üá∑üá∫ –†–æ—Å—Å–∏—è', cells: 0, percentage: 0 },
        { name: 'üá∫üá∏ –°–®–ê', cells: 0, percentage: 0 },
        { name: 'üá®üá≥ –ö–∏—Ç–∞–π', cells: 0, percentage: 0 },
        { name: 'üá®üá¶ –ö–∞–Ω–∞–¥–∞', cells: 0, percentage: 0 },
        { name: 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è', cells: 0, percentage: 0 },
        { name: 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è', cells: 0, percentage: 0 },
        { name: 'üáÆüá≥ –ò–Ω–¥–∏—è', cells: 0, percentage: 0 },
        { name: 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è', cells: 0, percentage: 0 },
        { name: 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è', cells: 0, percentage: 0 },
        { name: 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', cells: 0, percentage: 0 }
      ];
      
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å—Ç—Ä–∞–Ω—ã
      const existingNames = new Set(countryStats.map(s => s.name));
      for (const country of missingCountries) {
        if (!existingNames.has(country.name) && countryStats.length < 10) {
          countryStats.push(country);
        }
      }
    }
    
    res.status(200).json({
      success: true,
      allCells: allCells.slice(0, 10000), // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      totalCells: allCells.length,
      onlinePlayers,
      topCountries: countryStats.slice(0, 10),
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('Error in game-state:', error);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
    res.status(200).json({
      success: false,
      allCells: [],
      totalCells: 0,
      onlinePlayers: 1,
      topCountries: [
        { name: 'üá∑üá∫ –†–æ—Å—Å–∏—è', cells: 0, percentage: 0 },
        { name: 'üá∫üá∏ –°–®–ê', cells: 0, percentage: 0 },
        { name: 'üá®üá≥ –ö–∏—Ç–∞–π', cells: 0, percentage: 0 },
        { name: 'üá®üá¶ –ö–∞–Ω–∞–¥–∞', cells: 0, percentage: 0 },
        { name: 'üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è', cells: 0, percentage: 0 },
        { name: 'üá¶üá∫ –ê–≤—Å—Ç—Ä–∞–ª–∏—è', cells: 0, percentage: 0 },
        { name: 'üáÆüá≥ –ò–Ω–¥–∏—è', cells: 0, percentage: 0 },
        { name: 'üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è', cells: 0, percentage: 0 },
        { name: 'üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è', cells: 0, percentage: 0 },
        { name: 'üá¨üáß –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è', cells: 0, percentage: 0 }
      ],
      error: process.env.NODE_ENV === 'development' ? error.message : 'Database error'
    });
  }
}