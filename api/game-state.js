// API endpoint: Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ñ‹ Ğ¸ Ñ‚Ğ¾Ğ¿ ÑÑ‚Ñ€Ğ°Ğ½
import { Redis } from '@upstash/redis';

const kv = new Redis({
  url: process.env.KV_REST_API_URL,
  token: process.env.KV_REST_API_TOKEN,
});

// ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ ÑÑ‚Ñ€Ğ°Ğ½ Ğ² ĞºĞ¼Â² (Ğ¿Ñ€Ğ¸Ğ±Ğ»Ğ¸Ğ·Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ)
const COUNTRY_AREAS = {
  'RU': 17098242,  // Ğ Ğ¾ÑÑĞ¸Ñ
  'CA': 9984670,   // ĞšĞ°Ğ½Ğ°Ğ´Ğ°  
  'US': 9833517,   // Ğ¡Ğ¨Ğ
  'CN': 9596961,   // ĞšĞ¸Ñ‚Ğ°Ğ¹
  'BR': 8514877,   // Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ
  'AU': 7692024,   // ĞĞ²ÑÑ‚Ñ€Ğ°Ğ»Ğ¸Ñ
  'IN': 3287263,   // Ğ˜Ğ½Ğ´Ğ¸Ñ
  'AR': 2780400,   // ĞÑ€Ğ³ĞµĞ½Ñ‚Ğ¸Ğ½Ğ°
  'KZ': 2724900,   // ĞšĞ°Ğ·Ğ°Ñ…ÑÑ‚Ğ°Ğ½
  'DZ': 2381741,   // ĞĞ»Ğ¶Ğ¸Ñ€
  'SA': 2149690,   // Ğ¡Ğ°ÑƒĞ´Ğ¾Ğ²ÑĞºĞ°Ñ ĞÑ€Ğ°Ğ²Ğ¸Ñ
  'MX': 1964375,   // ĞœĞµĞºÑĞ¸ĞºĞ°
  'ID': 1904569,   // Ğ˜Ğ½Ğ´Ğ¾Ğ½ĞµĞ·Ğ¸Ñ
  'LY': 1759540,   // Ğ›Ğ¸Ğ²Ğ¸Ñ
  'IR': 1648195,   // Ğ˜Ñ€Ğ°Ğ½
  'MN': 1564110,   // ĞœĞ¾Ğ½Ğ³Ğ¾Ğ»Ğ¸Ñ
  'PE': 1285216,   // ĞŸĞµÑ€Ñƒ
  'TD': 1284000,   // Ğ§Ğ°Ğ´
  'NE': 1267000,   // ĞĞ¸Ğ³ĞµÑ€
  'AO': 1246700,   // ĞĞ½Ğ³Ğ¾Ğ»Ğ°
  'ML': 1240192,   // ĞœĞ°Ğ»Ğ¸
  'ZA': 1221037,   // Ğ®ĞĞ 
  'CO': 1141748,   // ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ğ¸Ñ
  'ET': 1104300,   // Ğ­Ñ„Ğ¸Ğ¾Ğ¿Ğ¸Ñ
  'BO': 1098581,   // Ğ‘Ğ¾Ğ»Ğ¸Ğ²Ğ¸Ñ
  'MR': 1025520,   // ĞœĞ°Ğ²Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ
  'EG': 1001450,   // Ğ•Ğ³Ğ¸Ğ¿ĞµÑ‚
  'TZ': 945087,    // Ğ¢Ğ°Ğ½Ğ·Ğ°Ğ½Ğ¸Ñ
  'NG': 923768,    // ĞĞ¸Ğ³ĞµÑ€Ğ¸Ñ
  'VE': 916445,    // Ğ’ĞµĞ½ĞµÑÑƒÑĞ»Ğ°
  'PK': 881913,    // ĞŸĞ°ĞºĞ¸ÑÑ‚Ğ°Ğ½
  'MZ': 801590,    // ĞœĞ¾Ğ·Ğ°Ğ¼Ğ±Ğ¸Ğº
  'TR': 783562,    // Ğ¢ÑƒÑ€Ñ†Ğ¸Ñ
  'CL': 756102,    // Ğ§Ğ¸Ğ»Ğ¸
  'ZM': 752612,    // Ğ—Ğ°Ğ¼Ğ±Ğ¸Ñ
  'MM': 676578,    // ĞœÑŒÑĞ½Ğ¼Ğ°
  'AF': 652230,    // ĞÑ„Ğ³Ğ°Ğ½Ğ¸ÑÑ‚Ğ°Ğ½
  'SO': 637657,    // Ğ¡Ğ¾Ğ¼Ğ°Ğ»Ğ¸
  'CF': 622984,    // Ğ¦ĞĞ 
  'UA': 603550,    // Ğ£ĞºÑ€Ğ°Ğ¸Ğ½Ğ°
  'MG': 587041,    // ĞœĞ°Ğ´Ğ°Ğ³Ğ°ÑĞºĞ°Ñ€
  'BW': 581730,    // Ğ‘Ğ¾Ñ‚ÑĞ²Ğ°Ğ½Ğ°
  'KE': 580367,    // ĞšĞµĞ½Ğ¸Ñ
  'FR': 551695,    // Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ
  'YE': 527968,    // Ğ™ĞµĞ¼ĞµĞ½
  'TH': 513120,    // Ğ¢Ğ°Ğ¸Ğ»Ğ°Ğ½Ğ´
  'ES': 505992,    // Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ñ
  'TM': 488100,    // Ğ¢ÑƒÑ€ĞºĞ¼ĞµĞ½Ğ¸ÑÑ‚Ğ°Ğ½
  'CM': 475442,    // ĞšĞ°Ğ¼ĞµÑ€ÑƒĞ½
  'PG': 462840,    // ĞŸĞ°Ğ¿ÑƒĞ°-ĞĞ¾Ğ²Ğ°Ñ Ğ“Ğ²Ğ¸Ğ½ĞµÑ
  'SE': 450295,    // Ğ¨Ğ²ĞµÑ†Ğ¸Ñ
  'UZ': 447400,    // Ğ£Ğ·Ğ±ĞµĞºĞ¸ÑÑ‚Ğ°Ğ½
  'MA': 446550,    // ĞœĞ°Ñ€Ğ¾ĞºĞºĞ¾
  'IQ': 438317,    // Ğ˜Ñ€Ğ°Ğº
  'PY': 406752,    // ĞŸĞ°Ñ€Ğ°Ğ³Ğ²Ğ°Ğ¹
  'ZW': 390757,    // Ğ—Ğ¸Ğ¼Ğ±Ğ°Ğ±Ğ²Ğµ
  'NO': 385207,    // ĞĞ¾Ñ€Ğ²ĞµĞ³Ğ¸Ñ
  'JP': 377975,    // Ğ¯Ğ¿Ğ¾Ğ½Ğ¸Ñ
  'DE': 357114,    // Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ
  'FI': 338424,    // Ğ¤Ğ¸Ğ½Ğ»ÑĞ½Ğ´Ğ¸Ñ
  'VN': 331212,    // Ğ’ÑŒĞµÑ‚Ğ½Ğ°Ğ¼
  'MY': 330803,    // ĞœĞ°Ğ»Ğ°Ğ¹Ğ·Ğ¸Ñ
  'CI': 322463,    // ĞšĞ¾Ñ‚-Ğ´'Ğ˜Ğ²ÑƒĞ°Ñ€
  'PL': 312696,    // ĞŸĞ¾Ğ»ÑŒÑˆĞ°
  'OM': 309500,    // ĞĞ¼Ğ°Ğ½
  'IT': 301339,    // Ğ˜Ñ‚Ğ°Ğ»Ğ¸Ñ
  'PH': 300000,    // Ğ¤Ğ¸Ğ»Ğ¸Ğ¿Ğ¿Ğ¸Ğ½Ñ‹
  'EC': 283561,    // Ğ­ĞºĞ²Ğ°Ğ´Ğ¾Ñ€
  'BF': 274222,    // Ğ‘ÑƒÑ€ĞºĞ¸Ğ½Ğ°-Ğ¤Ğ°ÑĞ¾
  'NZ': 270467,    // ĞĞ¾Ğ²Ğ°Ñ Ğ—ĞµĞ»Ğ°Ğ½Ğ´Ğ¸Ñ
  'GA': 267668,    // Ğ“Ğ°Ğ±Ğ¾Ğ½
  'GB': 242900,    // Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ
  'GN': 245857,    // Ğ“Ğ²Ğ¸Ğ½ĞµÑ
  'UG': 241550,    // Ğ£Ğ³Ğ°Ğ½Ğ´Ğ°
  'GH': 238533,    // Ğ“Ğ°Ğ½Ğ°
  'RO': 238391,    // Ğ ÑƒĞ¼Ñ‹Ğ½Ğ¸Ñ
  'LA': 236800,    // Ğ›Ğ°Ğ¾Ñ
  'GY': 214969,    // Ğ“Ğ°Ğ¹Ğ°Ğ½Ğ°
  'BY': 207600,    // Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑÑŒ
  'KG': 199951,    // ĞšĞ¸Ñ€Ğ³Ğ¸Ğ·Ğ¸Ñ
  'SN': 196722,    // Ğ¡ĞµĞ½ĞµĞ³Ğ°Ğ»
  'SY': 185180,    // Ğ¡Ğ¸Ñ€Ğ¸Ñ
  'KH': 181035,    // ĞšĞ°Ğ¼Ğ±Ğ¾Ğ´Ğ¶Ğ°
  'UY': 176215,    // Ğ£Ñ€ÑƒĞ³Ğ²Ğ°Ğ¹
  'TN': 163610,    // Ğ¢ÑƒĞ½Ğ¸Ñ
  'SR': 163820,    // Ğ¡ÑƒÑ€Ğ¸Ğ½Ğ°Ğ¼
  'BD': 147570,    // Ğ‘Ğ°Ğ½Ğ³Ğ»Ğ°Ğ´ĞµÑˆ
  'NP': 147181,    // ĞĞµĞ¿Ğ°Ğ»
  'TJ': 143100,    // Ğ¢Ğ°Ğ´Ğ¶Ğ¸ĞºĞ¸ÑÑ‚Ğ°Ğ½
  'GR': 131957,    // Ğ“Ñ€ĞµÑ†Ğ¸Ñ
  'NI': 130373,    // ĞĞ¸ĞºĞ°Ñ€Ğ°Ğ³ÑƒĞ°
  'KP': 120538,    // Ğ¡ĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ĞšĞ¾Ñ€ĞµÑ
  'MW': 118484,    // ĞœĞ°Ğ»Ğ°Ğ²Ğ¸
  'ER': 117600,    // Ğ­Ñ€Ğ¸Ñ‚Ñ€ĞµÑ
  'BJ': 114763,    // Ğ‘ĞµĞ½Ğ¸Ğ½
  'HN': 112492,    // Ğ“Ğ¾Ğ½Ğ´ÑƒÑ€Ğ°Ñ
  'LR': 111369,    // Ğ›Ğ¸Ğ±ĞµÑ€Ğ¸Ñ
  'BG': 110879,    // Ğ‘Ğ¾Ğ»Ğ³Ğ°Ñ€Ğ¸Ñ
  'CU': 109884,    // ĞšÑƒĞ±Ğ°
  'GT': 108889,    // Ğ“Ğ²Ğ°Ñ‚ĞµĞ¼Ğ°Ğ»Ğ°
  'IS': 103000,    // Ğ˜ÑĞ»Ğ°Ğ½Ğ´Ğ¸Ñ
  'KR': 100210,    // Ğ®Ğ¶Ğ½Ğ°Ñ ĞšĞ¾Ñ€ĞµÑ
  'HU': 93028,     // Ğ’ĞµĞ½Ğ³Ñ€Ğ¸Ñ
  'PT': 92090,     // ĞŸĞ¾Ñ€Ñ‚ÑƒĞ³Ğ°Ğ»Ğ¸Ñ
  'JO': 89342,     // Ğ˜Ğ¾Ñ€Ğ´Ğ°Ğ½Ğ¸Ñ
  'RS': 88361,     // Ğ¡ĞµÑ€Ğ±Ğ¸Ñ
  'AZ': 86600,     // ĞĞ·ĞµÑ€Ğ±Ğ°Ğ¹Ğ´Ğ¶Ğ°Ğ½
  'AT': 83879,     // ĞĞ²ÑÑ‚Ñ€Ğ¸Ñ
  'AE': 83600,     // ĞĞĞ­
  'CZ': 78867,     // Ğ§ĞµÑ…Ğ¸Ñ
  'PA': 75417,     // ĞŸĞ°Ğ½Ğ°Ğ¼Ğ°
  'SL': 71740,     // Ğ¡ÑŒĞµÑ€Ñ€Ğ°-Ğ›ĞµĞ¾Ğ½Ğµ
  'IE': 70273,     // Ğ˜Ñ€Ğ»Ğ°Ğ½Ğ´Ğ¸Ñ
  'GE': 69700,     // Ğ“Ñ€ÑƒĞ·Ğ¸Ñ
  'LK': 65610,     // Ğ¨Ñ€Ğ¸-Ğ›Ğ°Ğ½ĞºĞ°
  'LT': 65300,     // Ğ›Ğ¸Ñ‚Ğ²Ğ°
  'LV': 64559,     // Ğ›Ğ°Ñ‚Ğ²Ğ¸Ñ
  'TG': 56785,     // Ğ¢Ğ¾Ğ³Ğ¾
  'HR': 56594,     // Ğ¥Ğ¾Ñ€Ğ²Ğ°Ñ‚Ğ¸Ñ
  'BA': 51209,     // Ğ‘Ğ¾ÑĞ½Ğ¸Ñ Ğ¸ Ğ“ĞµÑ€Ñ†ĞµĞ³Ğ¾Ğ²Ğ¸Ğ½Ğ°
  'CR': 51100,     // ĞšĞ¾ÑÑ‚Ğ°-Ğ Ğ¸ĞºĞ°
  'SK': 49037,     // Ğ¡Ğ»Ğ¾Ğ²Ğ°ĞºĞ¸Ñ
  'DO': 48671,     // Ğ”Ğ¾Ğ¼Ğ¸Ğ½Ğ¸ĞºĞ°Ğ½ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°
  'EE': 45227,     // Ğ­ÑÑ‚Ğ¾Ğ½Ğ¸Ñ
  'DK': 43094,     // Ğ”Ğ°Ğ½Ğ¸Ñ
  'NL': 41850,     // ĞĞ¸Ğ´ĞµÑ€Ğ»Ğ°Ğ½Ğ´Ñ‹
  'CH': 41285,     // Ğ¨Ğ²ĞµĞ¹Ñ†Ğ°Ñ€Ğ¸Ñ
  'BT': 38394,     // Ğ‘ÑƒÑ‚Ğ°Ğ½
  'TW': 36193,     // Ğ¢Ğ°Ğ¹Ğ²Ğ°Ğ½ÑŒ
  'GW': 36125,     // Ğ“Ğ²Ğ¸Ğ½ĞµÑ-Ğ‘Ğ¸ÑĞ°Ñƒ
  'MD': 33846,     // ĞœĞ¾Ğ»Ğ´Ğ¾Ğ²Ğ°
  'BE': 30528,     // Ğ‘ĞµĞ»ÑŒĞ³Ğ¸Ñ
  'LS': 30355,     // Ğ›ĞµÑĞ¾Ñ‚Ğ¾
  'AM': 29743,     // ĞÑ€Ğ¼ĞµĞ½Ğ¸Ñ
  'SB': 28896,     // Ğ¡Ğ¾Ğ»Ğ¾Ğ¼Ğ¾Ğ½Ğ¾Ğ²Ñ‹ ĞÑÑ‚Ñ€Ğ¾Ğ²Ğ°
  'AL': 28748,     // ĞĞ»Ğ±Ğ°Ğ½Ğ¸Ñ
  'GQ': 28051,     // Ğ­ĞºĞ²Ğ°Ñ‚Ğ¾Ñ€Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ“Ğ²Ğ¸Ğ½ĞµÑ
  'BI': 27834,     // Ğ‘ÑƒÑ€ÑƒĞ½Ğ´Ğ¸
  'HT': 27750,     // Ğ“Ğ°Ğ¸Ñ‚Ğ¸
  'RW': 26338,     // Ğ ÑƒĞ°Ğ½Ğ´Ğ°
  'MK': 25713,     // Ğ¡ĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ĞœĞ°ĞºĞµĞ´Ğ¾Ğ½Ğ¸Ñ
  'BZ': 22966,     // Ğ‘ĞµĞ»Ğ¸Ğ·
  'DJ': 23200,     // Ğ”Ğ¶Ğ¸Ğ±ÑƒÑ‚Ğ¸
  'SV': 21041,     // Ğ¡Ğ°Ğ»ÑŒĞ²Ğ°Ğ´Ğ¾Ñ€
  'IL': 20770,     // Ğ˜Ğ·Ñ€Ğ°Ğ¸Ğ»ÑŒ
  'SI': 20273,     // Ğ¡Ğ»Ğ¾Ğ²ĞµĞ½Ğ¸Ñ
  'FJ': 18272,     // Ğ¤Ğ¸Ğ´Ğ¶Ğ¸
  'KW': 17818,     // ĞšÑƒĞ²ĞµĞ¹Ñ‚
  'SZ': 17364,     // Ğ­ÑĞ²Ğ°Ñ‚Ğ¸Ğ½Ğ¸
  'TL': 14919,     // Ğ’Ğ¾ÑÑ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¢Ğ¸Ğ¼Ğ¾Ñ€
  'BS': 13943,     // Ğ‘Ğ°Ğ³Ğ°Ğ¼Ñ‹
  'ME': 13812,     // Ğ§ĞµÑ€Ğ½Ğ¾Ğ³Ğ¾Ñ€Ğ¸Ñ
  'VU': 12189,     // Ğ’Ğ°Ğ½ÑƒĞ°Ñ‚Ñƒ
  'QA': 11586,     // ĞšĞ°Ñ‚Ğ°Ñ€
  'GM': 11295,     // Ğ“Ğ°Ğ¼Ğ±Ğ¸Ñ
  'JM': 10991,     // Ğ¯Ğ¼Ğ°Ğ¹ĞºĞ°
  'LB': 10452,     // Ğ›Ğ¸Ğ²Ğ°Ğ½
  'CY': 9251,      // ĞšĞ¸Ğ¿Ñ€
  'BN': 5765,      // Ğ‘Ñ€ÑƒĞ½ĞµĞ¹
  'TT': 5130,      // Ğ¢Ñ€Ğ¸Ğ½Ğ¸Ğ´Ğ°Ğ´ Ğ¸ Ğ¢Ğ¾Ğ±Ğ°Ğ³Ğ¾
  'CV': 4033,      // ĞšĞ°Ğ±Ğ¾-Ğ’ĞµÑ€Ğ´Ğµ
  'WS': 2842,      // Ğ¡Ğ°Ğ¼Ğ¾Ğ°
  'LU': 2586,      // Ğ›ÑĞºÑĞµĞ¼Ğ±ÑƒÑ€Ğ³
  'MU': 2040,      // ĞœĞ°Ğ²Ñ€Ğ¸ĞºĞ¸Ğ¹
  'KM': 1862,      // ĞšĞ¾Ğ¼Ğ¾Ñ€Ñ‹
  'ST': 964,       // Ğ¡Ğ°Ğ½-Ğ¢Ğ¾Ğ¼Ğµ Ğ¸ ĞŸÑ€Ğ¸Ğ½ÑĞ¸Ğ¿Ğ¸
  'BH': 765,       // Ğ‘Ğ°Ñ…Ñ€ĞµĞ¹Ğ½
  'DM': 751,       // Ğ”Ğ¾Ğ¼Ğ¸Ğ½Ğ¸ĞºĞ°
  'TO': 747,       // Ğ¢Ğ¾Ğ½Ğ³Ğ°
  'KI': 726,       // ĞšĞ¸Ñ€Ğ¸Ğ±Ğ°Ñ‚Ğ¸
  'SG': 718,       // Ğ¡Ğ¸Ğ½Ğ³Ğ°Ğ¿ÑƒÑ€
  'FM': 702,       // ĞœĞ¸ĞºÑ€Ğ¾Ğ½ĞµĞ·Ğ¸Ñ
  'LC': 616,       // Ğ¡ĞµĞ½Ñ‚-Ğ›ÑÑĞ¸Ñ
  'AD': 468,       // ĞĞ½Ğ´Ğ¾Ñ€Ñ€Ğ°
  'PW': 459,       // ĞŸĞ°Ğ»Ğ°Ñƒ
  'SC': 452,       // Ğ¡ĞµĞ¹ÑˆĞµĞ»Ñ‹
  'AG': 442,       // ĞĞ½Ñ‚Ğ¸Ğ³ÑƒĞ° Ğ¸ Ğ‘Ğ°Ñ€Ğ±ÑƒĞ´Ğ°
  'BB': 430,       // Ğ‘Ğ°Ñ€Ğ±Ğ°Ğ´Ğ¾Ñ
  'VC': 389,       // Ğ¡ĞµĞ½Ñ‚-Ğ’Ğ¸Ğ½ÑĞµĞ½Ñ‚ Ğ¸ Ğ“Ñ€ĞµĞ½Ğ°Ğ´Ğ¸Ğ½Ñ‹
  'GD': 344,       // Ğ“Ñ€ĞµĞ½Ğ°Ğ´Ğ°
  'MT': 316,       // ĞœĞ°Ğ»ÑŒÑ‚Ğ°
  'MV': 300,       // ĞœĞ°Ğ»ÑŒĞ´Ğ¸Ğ²Ñ‹
  'KN': 261,       // Ğ¡ĞµĞ½Ñ‚-ĞšĞ¸Ñ‚Ñ Ğ¸ ĞĞµĞ²Ğ¸Ñ
  'MH': 181,       // ĞœĞ°Ñ€ÑˆĞ°Ğ»Ğ»Ğ¾Ğ²Ñ‹ ĞÑÑ‚Ñ€Ğ¾Ğ²Ğ°
  'LI': 160,       // Ğ›Ğ¸Ñ…Ñ‚ĞµĞ½ÑˆÑ‚ĞµĞ¹Ğ½
  'SM': 61,        // Ğ¡Ğ°Ğ½-ĞœĞ°Ñ€Ğ¸Ğ½Ğ¾
  'TV': 26,        // Ğ¢ÑƒĞ²Ğ°Ğ»Ñƒ
  'NR': 21,        // ĞĞ°ÑƒÑ€Ñƒ
  'MC': 2,         // ĞœĞ¾Ğ½Ğ°ĞºĞ¾
  'VA': 0.44,      // Ğ’Ğ°Ñ‚Ğ¸ĞºĞ°Ğ½
  'XX': 1          // ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ°
};

// Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ĞºĞ»ĞµÑ‚ĞºĞ¸ Ğ² ĞºĞ¼Â² (10x10 ĞºĞ¼)
const CELL_SIZE_KM2 = 100;

export default async function handler(req, res) {
  // CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET');
  
  try {
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ ĞºĞ»ĞµÑ‚ĞºĞ¸
    const allCells = await kv.smembers('revealed:cells') || [];
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² (Ñ‚Ğµ ĞºÑ‚Ğ¾ Ğ±Ñ‹Ğ» Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚)
    const now = Date.now();
    const fiveMinutesAgo = now - (5 * 60 * 1000);
    const recentActivity = await kv.zrange('revealed:timeline', fiveMinutesAgo, now, {
      byScore: true
    }) || [];
    
    const uniquePlayers = new Set();
    recentActivity.forEach(item => {
      if (item && item.member) {
        const parts = item.member.split(':');
        if (parts[1]) uniquePlayers.add(parts[1]);
      }
    });
    
    const onlinePlayers = Math.max(1, uniquePlayers.size);
    
    // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ°Ğ¼
    const countryStats = [];
    const countryData = await kv.hgetall('country:revealed:count') || {};
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ¿-10 ÑÑ‚Ñ€Ğ°Ğ½ Ñ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ Ñ€Ğ°ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… ĞºĞ»ĞµÑ‚Ğ¾Ğº
    const sortedCountries = Object.entries(countryData)
      .map(([code, count]) => ({
        code,
        count: parseInt(count) || 0
      }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);
    
    // Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ğ¸Ğ· Ñ‚Ğ¾Ğ¿-10 ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚
    for (const { code, count } of sortedCountries) {
      const countryArea = COUNTRY_AREAS[code] || 100000; // ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ğ² ĞºĞ¼Â²
      const maxCells = Math.floor(countryArea / CELL_SIZE_KM2); // ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ ĞºĞ»ĞµÑ‚Ğ¾Ğº Ğ² ÑÑ‚Ñ€Ğ°Ğ½Ğµ
      const percentage = ((count / maxCells) * 100).toFixed(4);
      
      // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ñ„Ğ»Ğ°Ğ³
      let name = 'ğŸŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾';
      if (code === 'RU') name = 'ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ';
      else if (code === 'US') name = 'ğŸ‡ºğŸ‡¸ Ğ¡Ğ¨Ğ';
      else if (code === 'CN') name = 'ğŸ‡¨ğŸ‡³ ĞšĞ¸Ñ‚Ğ°Ğ¹';
      else if (code === 'CA') name = 'ğŸ‡¨ğŸ‡¦ ĞšĞ°Ğ½Ğ°Ğ´Ğ°';
      else if (code === 'BR') name = 'ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ';
      else if (code === 'AU') name = 'ğŸ‡¦ğŸ‡º ĞĞ²ÑÑ‚Ñ€Ğ°Ğ»Ğ¸Ñ';
      else if (code === 'IN') name = 'ğŸ‡®ğŸ‡³ Ğ˜Ğ½Ğ´Ğ¸Ñ';
      else if (code === 'FR') name = 'ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ';
      else if (code === 'DE') name = 'ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ';
      else if (code === 'IT') name = 'ğŸ‡®ğŸ‡¹ Ğ˜Ñ‚Ğ°Ğ»Ğ¸Ñ';
      else if (code === 'ES') name = 'ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ñ';
      else if (code === 'GB') name = 'ğŸ‡¬ğŸ‡§ Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ';
      else if (code === 'JP') name = 'ğŸ‡¯ğŸ‡µ Ğ¯Ğ¿Ğ¾Ğ½Ğ¸Ñ';
      else if (code === 'KR') name = 'ğŸ‡°ğŸ‡· Ğ®Ğ¶Ğ½Ğ°Ñ ĞšĞ¾Ñ€ĞµÑ';
      else if (code === 'MX') name = 'ğŸ‡²ğŸ‡½ ĞœĞµĞºÑĞ¸ĞºĞ°';
      else if (code === 'AR') name = 'ğŸ‡¦ğŸ‡· ĞÑ€Ğ³ĞµĞ½Ñ‚Ğ¸Ğ½Ğ°';
      else if (code === 'ZA') name = 'ğŸ‡¿ğŸ‡¦ Ğ®ĞĞ ';
      else if (code === 'EG') name = 'ğŸ‡ªğŸ‡¬ Ğ•Ğ³Ğ¸Ğ¿ĞµÑ‚';
      else if (code === 'TR') name = 'ğŸ‡¹ğŸ‡· Ğ¢ÑƒÑ€Ñ†Ğ¸Ñ';
      else if (code === 'SA') name = 'ğŸ‡¸ğŸ‡¦ Ğ¡Ğ°ÑƒĞ´Ğ¾Ğ²ÑĞºĞ°Ñ ĞÑ€Ğ°Ğ²Ğ¸Ñ';
      else if (code === 'ID') name = 'ğŸ‡®ğŸ‡© Ğ˜Ğ½Ğ´Ğ¾Ğ½ĞµĞ·Ğ¸Ñ';
      else if (code === 'TH') name = 'ğŸ‡¹ğŸ‡­ Ğ¢Ğ°Ğ¸Ğ»Ğ°Ğ½Ğ´';
      else if (code === 'VN') name = 'ğŸ‡»ğŸ‡³ Ğ’ÑŒĞµÑ‚Ğ½Ğ°Ğ¼';
      else if (code === 'PH') name = 'ğŸ‡µğŸ‡­ Ğ¤Ğ¸Ğ»Ğ¸Ğ¿Ğ¿Ğ¸Ğ½Ñ‹';
      else if (code === 'PL') name = 'ğŸ‡µğŸ‡± ĞŸĞ¾Ğ»ÑŒÑˆĞ°';
      else if (code === 'UA') name = 'ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ğ¸Ğ½Ğ°';
      else if (code === 'BY') name = 'ğŸ‡§ğŸ‡¾ Ğ‘ĞµĞ»Ğ°Ñ€ÑƒÑÑŒ';
      else if (code === 'KZ') name = 'ğŸ‡°ğŸ‡¿ ĞšĞ°Ğ·Ğ°Ñ…ÑÑ‚Ğ°Ğ½';
      else if (code === 'SE') name = 'ğŸ‡¸ğŸ‡ª Ğ¨Ğ²ĞµÑ†Ğ¸Ñ';
      else if (code === 'NO') name = 'ğŸ‡³ğŸ‡´ ĞĞ¾Ñ€Ğ²ĞµĞ³Ğ¸Ñ';
      else if (code === 'FI') name = 'ğŸ‡«ğŸ‡® Ğ¤Ğ¸Ğ½Ğ»ÑĞ½Ğ´Ğ¸Ñ';
      else if (code === 'DK') name = 'ğŸ‡©ğŸ‡° Ğ”Ğ°Ğ½Ğ¸Ñ';
      else if (code === 'NL') name = 'ğŸ‡³ğŸ‡± ĞĞ¸Ğ´ĞµÑ€Ğ»Ğ°Ğ½Ğ´Ñ‹';
      else if (code === 'BE') name = 'ğŸ‡§ğŸ‡ª Ğ‘ĞµĞ»ÑŒĞ³Ğ¸Ñ';
      else if (code === 'CH') name = 'ğŸ‡¨ğŸ‡­ Ğ¨Ğ²ĞµĞ¹Ñ†Ğ°Ñ€Ğ¸Ñ';
      else if (code === 'AT') name = 'ğŸ‡¦ğŸ‡¹ ĞĞ²ÑÑ‚Ñ€Ğ¸Ñ';
      else if (code === 'CZ') name = 'ğŸ‡¨ğŸ‡¿ Ğ§ĞµÑ…Ğ¸Ñ';
      else if (code === 'PT') name = 'ğŸ‡µğŸ‡¹ ĞŸĞ¾Ñ€Ñ‚ÑƒĞ³Ğ°Ğ»Ğ¸Ñ';
      else if (code === 'GR') name = 'ğŸ‡¬ğŸ‡· Ğ“Ñ€ĞµÑ†Ğ¸Ñ';
      else if (code === 'RO') name = 'ğŸ‡·ğŸ‡´ Ğ ÑƒĞ¼Ñ‹Ğ½Ğ¸Ñ';
      else if (code === 'HU') name = 'ğŸ‡­ğŸ‡º Ğ’ĞµĞ½Ğ³Ñ€Ğ¸Ñ';
      else if (code === 'BG') name = 'ğŸ‡§ğŸ‡¬ Ğ‘Ğ¾Ğ»Ğ³Ğ°Ñ€Ğ¸Ñ';
      else if (code === 'RS') name = 'ğŸ‡·ğŸ‡¸ Ğ¡ĞµÑ€Ğ±Ğ¸Ñ';
      else if (code === 'HR') name = 'ğŸ‡­ğŸ‡· Ğ¥Ğ¾Ñ€Ğ²Ğ°Ñ‚Ğ¸Ñ';
      else if (code === 'SI') name = 'ğŸ‡¸ğŸ‡® Ğ¡Ğ»Ğ¾Ğ²ĞµĞ½Ğ¸Ñ';
      else if (code === 'SK') name = 'ğŸ‡¸ğŸ‡° Ğ¡Ğ»Ğ¾Ğ²Ğ°ĞºĞ¸Ñ';
      else if (code === 'LT') name = 'ğŸ‡±ğŸ‡¹ Ğ›Ğ¸Ñ‚Ğ²Ğ°';
      else if (code === 'LV') name = 'ğŸ‡±ğŸ‡» Ğ›Ğ°Ñ‚Ğ²Ğ¸Ñ';
      else if (code === 'EE') name = 'ğŸ‡ªğŸ‡ª Ğ­ÑÑ‚Ğ¾Ğ½Ğ¸Ñ';
      else if (code === 'IE') name = 'ğŸ‡®ğŸ‡ª Ğ˜Ñ€Ğ»Ğ°Ğ½Ğ´Ğ¸Ñ';
      else if (code === 'IS') name = 'ğŸ‡®ğŸ‡¸ Ğ˜ÑĞ»Ğ°Ğ½Ğ´Ğ¸Ñ';
      else if (code === 'NZ') name = 'ğŸ‡³ğŸ‡¿ ĞĞ¾Ğ²Ğ°Ñ Ğ—ĞµĞ»Ğ°Ğ½Ğ´Ğ¸Ñ';
      else if (code === 'CL') name = 'ğŸ‡¨ğŸ‡± Ğ§Ğ¸Ğ»Ğ¸';
      else if (code === 'CO') name = 'ğŸ‡¨ğŸ‡´ ĞšĞ¾Ğ»ÑƒĞ¼Ğ±Ğ¸Ñ';
      else if (code === 'PE') name = 'ğŸ‡µğŸ‡ª ĞŸĞµÑ€Ñƒ';
      else if (code === 'VE') name = 'ğŸ‡»ğŸ‡ª Ğ’ĞµĞ½ĞµÑÑƒÑĞ»Ğ°';
      else if (code === 'EC') name = 'ğŸ‡ªğŸ‡¨ Ğ­ĞºĞ²Ğ°Ğ´Ğ¾Ñ€';
      else if (code === 'BO') name = 'ğŸ‡§ğŸ‡´ Ğ‘Ğ¾Ğ»Ğ¸Ğ²Ğ¸Ñ';
      else if (code === 'PY') name = 'ğŸ‡µğŸ‡¾ ĞŸĞ°Ñ€Ğ°Ğ³Ğ²Ğ°Ğ¹';
      else if (code === 'UY') name = 'ğŸ‡ºğŸ‡¾ Ğ£Ñ€ÑƒĞ³Ğ²Ğ°Ğ¹';
      else if (code === 'GY') name = 'ğŸ‡¬ğŸ‡¾ Ğ“Ğ°Ğ¹Ğ°Ğ½Ğ°';
      else if (code === 'SR') name = 'ğŸ‡¸ğŸ‡· Ğ¡ÑƒÑ€Ğ¸Ğ½Ğ°Ğ¼';
      
      countryStats.push({
        name,
        cells: count,
        percentage: parseFloat(percentage),
        maxCells
      });
    }
    
    // Ğ•ÑĞ»Ğ¸ Ğ¼ĞµĞ½ÑŒÑˆĞµ 10 ÑÑ‚Ñ€Ğ°Ğ½, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹ Ñ 0 ĞºĞ»ĞµÑ‚ĞºĞ°Ğ¼Ğ¸
    if (countryStats.length < 10) {
      const missingCountries = [
        { name: 'ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡ºğŸ‡¸ Ğ¡Ğ¨Ğ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¨ğŸ‡³ ĞšĞ¸Ñ‚Ğ°Ğ¹', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¨ğŸ‡¦ ĞšĞ°Ğ½Ğ°Ğ´Ğ°', cells: 0, percentage: 0 },
        { name: 'ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¦ğŸ‡º ĞĞ²ÑÑ‚Ñ€Ğ°Ğ»Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡®ğŸ‡³ Ğ˜Ğ½Ğ´Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¬ğŸ‡§ Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ', cells: 0, percentage: 0 }
      ];
      
      // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğµ ÑÑ‚Ñ€Ğ°Ğ½Ñ‹
      const existingNames = new Set(countryStats.map(s => s.name));
      for (const country of missingCountries) {
        if (!existingNames.has(country.name) && countryStats.length < 10) {
          countryStats.push(country);
        }
      }
    }
    
    res.status(200).json({
      success: true,
      allCells: allCells.slice(0, 10000), // ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸
      totalCells: allCells.length,
      onlinePlayers,
      topCountries: countryStats.slice(0, 10),
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('Error in game-state:', error);
    
    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
    res.status(200).json({
      success: false,
      allCells: [],
      totalCells: 0,
      onlinePlayers: 1,
      topCountries: [
        { name: 'ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡ºğŸ‡¸ Ğ¡Ğ¨Ğ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¨ğŸ‡³ ĞšĞ¸Ñ‚Ğ°Ğ¹', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¨ğŸ‡¦ ĞšĞ°Ğ½Ğ°Ğ´Ğ°', cells: 0, percentage: 0 },
        { name: 'ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¦ğŸ‡º ĞĞ²ÑÑ‚Ñ€Ğ°Ğ»Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡®ğŸ‡³ Ğ˜Ğ½Ğ´Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ', cells: 0, percentage: 0 },
        { name: 'ğŸ‡¬ğŸ‡§ Ğ’ĞµĞ»Ğ¸ĞºĞ¾Ğ±Ñ€Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ', cells: 0, percentage: 0 }
      ],
      error: process.env.NODE_ENV === 'development' ? error.message : 'Database error'
    });
  }
}