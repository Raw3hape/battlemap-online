# BattleMap v2 - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

## üìã –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

BattleMap v2 - —ç—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –æ–Ω–ª–∞–π–Ω-–∏–≥—Ä–∞, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –∫–∞—Ä—Ç—É –º–∏—Ä–∞, —É–±–∏—Ä–∞—è "—Ç—É–º–∞–Ω –≤–æ–π–Ω—ã" —Å –∫–ª–µ—Ç–æ–∫ —Ä–∞–∑–º–µ—Ä–æ–º 10x10 –∫–º. –ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Leaflet –¥–ª—è –∫–∞—Ä—Ç, Canvas –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç—É–º–∞–Ω–∞, –∏ Upstash Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –§—Ä–æ–Ω—Ç–µ–Ω–¥
- **Leaflet.js** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç—ã
- **Canvas API** - —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç—É–º–∞–Ω–∞ –∏ —Å–µ—Ç–∫–∏
- **Vanilla JavaScript** - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

### –ë—ç–∫–µ–Ω–¥
- **Vercel Serverless Functions** - API endpoints
- **Upstash Redis** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
- **KV Storage** - –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
BattleMap v2/
‚îú‚îÄ‚îÄ api/                      # Serverless —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ reveal-batch.js      # –ë–∞—Ç—á–∏–Ω–≥ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∫–ª–µ—Ç–æ–∫
‚îÇ   ‚îú‚îÄ‚îÄ game-state.js        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
‚îÇ   ‚îú‚îÄ‚îÄ player-stats.js      # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ admin/               # –ê–¥–º–∏–Ω-—Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ       ‚îî‚îÄ‚îÄ reset.js         # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îÇ
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ js/                  # JavaScript –º–æ–¥—É–ª–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ battlemap-stable.js    # –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ battlemap-final.js     # –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ battlemap-optimized.js # –í–µ—Ä—Å–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Å–ø–∞–º–∞
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ css/
‚îÇ       ‚îú‚îÄ‚îÄ main.css         # –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îÇ       ‚îî‚îÄ‚îÄ main-mobile.css  # –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
‚îÇ
‚îú‚îÄ‚îÄ index.html               # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
‚îú‚îÄ‚îÄ vercel.json             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Vercel
‚îî‚îÄ‚îÄ package.json            # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## üéÆ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –†–µ–∂–∏–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### –î–µ—Å–∫—Ç–æ–ø
- **–ö–ª–∏–∫** - —Ä–∞—Å–∫—Ä—ã—Ç—å –æ–¥–Ω—É –∫–ª–µ—Ç–∫—É
- **Shift + –õ–ö–ú –∏–ª–∏ –ü–ö–ú** - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
- **–ö–æ–ª–µ—Å–æ –º—ã—à–∏** - –∑—É–º

#### –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- **–¢–∞–ø** - —Ä–∞—Å–∫—Ä—ã—Ç—å –∫–ª–µ—Ç–∫—É
- **–°–≤–∞–π–ø** - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
- **–©–∏–ø–æ–∫** - –∑—É–º
- **–î–≤–æ–π–Ω–æ–π —Ç–∞–ø** - –±—ã—Å—Ç—Ä—ã–π –∑—É–º

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- –°–µ—Ç–∫–∞ –∫–ª–µ—Ç–æ–∫ 10x10 –∫–º
- –ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–æ 10 –∫–ª–µ—Ç–æ–∫)
- Rate limiting (5 –∫–ª–∏–∫–æ–≤/—Å–µ–∫)
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
- –¢–µ–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞
- 8 —Å—Ç–∏–ª–µ–π –∫–∞—Ä—Ç
- –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

## üöÄ API Endpoints

### `/api/reveal-batch`
```javascript
POST /api/reveal-batch
{
  cells: ["55.7558,37.6173", ...],
  playerId: "player_abc123",
  timestamp: 1234567890
}
```

### `/api/game-state`
```javascript
GET /api/game-state
Response: {
  allCells: [...],
  totalCells: 1234,
  onlinePlayers: 42,
  topCountries: [...]
}
```

## ‚ö° –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### iOS Safari
- –û—Ç–∫–ª—é—á–µ–Ω—ã –∞–Ω–∏–º–∞—Ü–∏–∏ (`fadeAnimation: false`)
- Canvas —Å `willReadFrequently: false`
- Throttling —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (100–º—Å)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–µ—Ç–æ–∫ (1000)

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- Viewport-based —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥
- –ë–∞—Ç—á–∏–Ω–≥ Canvas –æ–ø–µ—Ä–∞—Ü–∏–π
- RequestAnimationFrame –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–ª–æ–≤ –∫–∞—Ä—Ç—ã

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: iPhone Safari –∑–∞–≤–∏—Å–∞–µ—Ç –ø—Ä–∏ –∑—É–º–µ
**–†–µ—à–µ–Ω–∏–µ**: –û—Ç–∫–ª—é—á–µ–Ω—ã –∞–Ω–∏–º–∞—Ü–∏–∏ Leaflet –¥–ª—è iOS, –¥–æ–±–∞–≤–ª–µ–Ω throttling

### –ü—Ä–æ–±–ª–µ–º–∞: –î–µ—Å–∫—Ç–æ–ø drag –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
**–†–µ—à–µ–Ω–∏–µ**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Shift+–õ–ö–ú –∏–ª–∏ –ü–ö–ú

### –ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ tap-only —Ä–µ–∂–∏–º (–±–µ–∑ drawing mode)

### –ü—Ä–æ–±–ª–µ–º–∞: 500 –æ—à–∏–±–∫–∞ "Failed to parse URL from /pipeline"
**–†–µ—à–µ–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º—ã—Ö Redis –∫–æ–º–∞–Ω–¥ –≤–º–µ—Å—Ç–æ pipeline

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
KV_REST_API_URL=https://your-redis-url.upstash.io
KV_REST_API_TOKEN=your-token-here
```

## üìä –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```javascript
// –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏
CELL_SIZE_KM = 10;
CELL_SIZE_LAT = 10 / 111;

// –ë–∞—Ç—á–∏–Ω–≥
batchDelay = 500ms;
maxBatchSize = 10;

// Rate limiting
maxClicksPerSecond = 5;
revealCooldown = 200ms;

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
syncDelay = 20000ms;

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
renderDelay = 100ms;
maxCells = 1000;      // –î–ª—è iOS
maxLines = 100;       // –î–ª—è —Å–µ—Ç–∫–∏
```

## üé® –¢–µ–º—ã –∏ —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç

### –¢–µ–º—ã
- `dark` - —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `light` - —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞

### –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç
- `osm` - OpenStreetMap
- `hot` - OSM HOT
- `topo` - –¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è
- `positron` - CartoDB Light
- `dark` - CartoDB Dark
- `satellite` - –°–ø—É—Ç–Ω–∏–∫

## üì± –í–µ—Ä—Å–∏–∏ JavaScript —Ñ–∞–π–ª–æ–≤

### battlemap-stable.js (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è iOS
- Tap-only —Ä–µ–∂–∏–º
- –†–∞–∑–¥–µ–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ desktop/mobile

### battlemap-final.js
- –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- Drawing mode (–º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É)
- Rate limiting 5 –∫–ª–∏–∫/—Å–µ–∫

### battlemap-optimized.js
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- Viewport caching
- Rate limiting 15 –∫–ª–∏–∫/—Å–µ–∫

## üöÄ –î–µ–ø–ª–æ–π

1. –ü—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è Vercel
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –∏–∑ GitHub
3. Serverless —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –ø–∞–ø–∫–µ `/api`
4. –°—Ç–∞—Ç–∏–∫–∞ –≤ –ø–∞–ø–∫–µ `/public`

## üíæ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ

```javascript
localStorage:
- battleMapPlayerId - ID –∏–≥—Ä–æ–∫–∞
- battleMapProgress - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
- battleMapTheme - –≤—ã–±—Ä–∞–Ω–Ω–∞—è —Ç–µ–º–∞
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- FPS –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ API
- –†–∞–∑–º–µ—Ä –±–∞—Ç—á–µ–π
- Rate limit hits
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫

## üîÑ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤
3. –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª–µ—Ç–æ–∫
4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ CDN
5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –∏ –≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏–∏

## üìù –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

```bash
# –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev

# –î–µ–ø–ª–æ–π –Ω–∞ Vercel
vercel --prod

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
vercel logs
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ battlemap-stable.js –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** - —Å–∞–º–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
2. **iOS —Ç—Ä–µ–±—É–µ—Ç –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è** - –æ—Ç–∫–ª—é—á–∞–π—Ç–µ –∞–Ω–∏–º–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ throttling
3. **Rate limiting –∫—Ä–∏—Ç–∏—á–µ–Ω** - –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
4. **Upstash –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ pipeline –∫–æ–º–∞–Ω–¥—ã
5. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** - —ç–º—É–ª—è—Ç–æ—Ä—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã

## ü§ù –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –ö–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏
2. Network tab –Ω–∞ 500 –æ—à–∏–±–∫–∏
3. Vercel –ª–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏
4. Redis –º–µ—Ç—Ä–∏–∫–∏ –≤ Upstash dashboard

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –î–µ–∫–∞–±—Ä—å 2024*
*–í–µ—Ä—Å–∏—è: 2.0 (stable)*